# 프로세스 동기화

- 목차
    1. 프로세스 간 통신
    2. 공유자원과 임계구역
    3. 세마포어
    4. 모니터
    5. 교착상태(데드락)
        1. 교착상태 해결


## 프로세스 간 통신

프로세스는 기본적으로 독립적으로 실행되지만 프로세스 간 데이터를 주고받으며 통신을 하는 경우도 있다.

통신은 같은 컴퓨터 내의 두 프로세스끼리 할 수도 있고 네트워크로 연결된 다른 컴퓨터와 통신을 할 수도 있다.

같은 컴퓨터 내에서 통신하는 첫 번째 방법으로는 파일과 파이프를 이용하는 방법이 있다.

파일을 이용하는 방법은 서로 다른 프로세스들이 하나의 파일을 이용해 읽고 쓰는 방법이다.

파이프를 이용하는 방법은 운영체제가 생성한 파이프를 이용해 데이터를 읽고 쓰는 방법이다.

두 번째 방법으로는 쓰레드를 이용하는 방법이다.

이 방법은 한 프로세스 내에서 쓰레드 간 통신을 하는 방법이다.

쓰레드는 코드, 데이터, 힙영역을 공유하고 스택만 각자 자기의 것을 가지고 있다.

여기서 데이터 영역에 있는 전역변수나 힙을 이용하면 통신이 가능하다.

세 번째 방법으로는 네트워크를 이용한 방법이 있다.

운영체제가 제공하는 소켓통신이나 다른 컴퓨터에 있는 함수를 호출하는 RPC(원격 프로시저 호출)를 이용해 통신하는 방법이 있다.

## 공유자원과 임계구역

공유자원이란 프로세스 간 통신을 할 때 공동으로 이용하는 변수나 파일들을 의미한다.

공유자원은 여러 프로세스가 공유하고 있기 때문에 각 프로세스의 접근 순서에 따라 결과가 달라질 수 있다.

또한 컨텍스트 스위칭으로 시분할 처리를 하기 때문에 어떤 프로세스가 먼저 실행되고 어떤 프로세스가 나중에 실행되는지 예측하기가 힘들다.

따라서 연산결과를 예측하기 힘들고 여기서 발생한 문제를 "동기화 문제"라고 부른다.

이러한 동기화 문제 때문에 여러 프로세스가 동시에 사용하면 안되는 영역을 "임계구역"이라고 부른다.

공유자원을 서로 사용하기 위해 경쟁하는 것을 "경쟁조건"이라고 부른다.

임계구역 문제를 해결하기 위해서는 상호 배제의 메커니즘이 필요하다.

상호 배제 메커니즘의 요구사항은 세가지가 있다.

- 임계영역엔 동시에 하나의 프로세스만 접근한다.
- 여러 요청에도 하나의 프로세스의 접근만 허용한다.
- 임계구역에 들어간 프로세스는 빠르게 나와야한다.

## 세마포어

세마포어는 상호 배제의 원리는 보장하는 열쇠이다.

임계 구역에 대해 각각의 프로세스들의 접근을 제어하고 프로세스 사이의 동기를 유지한다.

세마포어는 일반적으로 정수형 값으로 선언되며 1개 이상이 값이 될 수 있다.

간단한 예시로 탈의실을 생각해보자.

탈의실의 열쇠는 한개가 있다.

이때 사용자1(프로세스)이 관리자(운영체제)에게 탈의실(공유 자원)을 사용하기 위해서 탈의실 열쇠(세마포어)를 요청한다.

관리자는 사용자에게 열쇠를 넘겨주고 기다린다.

그 사이 다른 사용자2가 나타나 관리자에게 탈의실 열쇠를 요구하지만 탈의실이 사용중이기 때문에 대기하라고 말한다.

사용자2는 대기줄(대기 큐)에서 기다린다.

사용자1이 탈의실 사용을 마치고 관리자에게 열쇠를 반납한다.

위의 예시처럼 세마포어를 통해 공유 자원의 동기를 유지할 수 있다.

하지만 세마포어는 코드를 구성함에 있어 잘못된 사용으로 인해 버그가 발생 할 수 있다는 문제가 있다.

## 모니터

모니터는 세마포어의 단점을 해결한 상호 배제 메커니즘이다.

모니터는 운영체제가 처리하는것이 아니라 프로그래밍 언어 차원에서 지원하는 방법이다.

예시로 자바의 'synchronized'라는 키워드가 있다.

메서드를 생성할 때 synchronized를 붙여서 생성할 수 있는데 해당 메서드들은 동시에 여러 프로세스에서 실행시킬 수 없다.

즉 상호 배제가 완벽하게 이루어 진다.

## 교착상태(데드락)

여러 프로세스가 서로 다른 프로세스의 작업이 끝나기를 기다리다가 아무도 작업을 진행하지 못하는 상태를 "교착상태(데드락)"이라고 한다.

교착상태가 발생하는 이유는 공유자원 때문이다.

만약 어떤 자원을 여러 개의 프로세스가 공유하지 않는다면 교착상태는 발생하지 않는다.

교착상태의 필요조건은 네가지가 있는데 이 중 한 가지라도 충족하지 않는다면 교착상태는 발생하지 않는다.

- 상호 배제: 어떤 프로세스가 한 리소스를 점유했다면 그 리소스는 다른 프로세스에게 공유가 되면 안된다.
- 비선점: 한 프로세스가 리소스를 점유하고 있을 때 다른 프로세스가 리소르를 빼앗을 수 없어야한다.
- 점유와 대기: 한 프로세스가 리소스A를 가지고 있는 상태에서 리소스B를 원하는 상태여야 한다.
- 원형 대기: 점유와 대기를 하는 프로세스들의 관계가 원형을 이루고 있다는 것이다.

운영체제를 연구하는 사람들은 교착상태를 예방하는 방법을 연구하려 했으나 너무 비효율적인 방법이라 해결하는 방법으로 연구하였다.

### 교착상태 해결

교착상태 해결 방법으로 교착상태 회피라는 방법이 있다.

운영체제가 프로세스들에게 자원을 할당할 때 어느정도 자원을 할당해야 교착상태가 발생하는지 파악해서 교착상태가 발생하지 않는 수준의 자원을 할당한다.

교착상태 회피는 전체 자원의 수와 할당된 자원의 수를 기준으로 "안정상태"와 "불안정상태"로 나눈다.

운영체제는 최대한 안정상태를 유지하려고 자원할당을 한다.

불안정상태에 있더라도 무조건 교착상태에 빠지는것이 아니라 교착상태에 빠질 확률이 높아진다.

운영체제를 연구하는 사람들은 교착상태 회피로는 교착상태를 확실하게 피할 수 없고 비효율 적인 방법이라 해결하는 방법으로 연구했다.

우선 교착상태를 어떻게 검출할까 고민했고 두가지 방식을 찾았다.

첫 번째 방식은 "가벼운 교착 상태 검출"이라고 부른다.

이 방식은 타이머를 이용하는 방식인데 프로세스가 일정시간 동안 작업을 진행하지 않는다면 교착상태가 발생했다고 간주하고 교착상태를 해결한다.

일정 시점마다 체크포인트를 만들어 작업을 저장하고 타임아웃으로 교착상태가 발생하면 마지막으로 저장했던 체크포인트로 롤백하는 것이다.

두 번째 방식은 "무거운 교착 상태 검출"이라고 부른다.

이 방식은 "자원 할당 그래프"를 이용하는데 현재 운영체제에서 프로세스가 어떤 자원을 사용하는지 지켜보고 교착상태가 발생했다면 해결한다.

자원 할당 그래프가 순환구조가 생기면 교착상태로 파악하고 교착상태를 일으킨 프로세스를 강제종료시킨다.

그리고 다시 실행할 때 체크포인트로 롤백시킨다.

이 방식은 운영체제가 지속적으로 자원 할당 그래프를 유지하고 검사해야 하기 때문에 오버헤드가 발생한다.

하지만 가벼운 교착 상태 검출에서 발생하는 억울하게 종료되는 프로세스는 발생하지 않는다.
